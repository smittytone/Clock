<!DOCTYPE html>
<html lang='en'>
<head>
    <title>cløck</title>
    <link rel='stylesheet' href='https://maxcdn.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css'>
    <link href='https://fonts.googleapis.com/css?family=Rubik|Michroma' rel='stylesheet'>
    <link rel='apple-touch-icon' href='https://smittytone.github.io/images/ati-clock.png'>
    <link rel='shortcut icon' href='https://smittytone.github.io/images/ico-clock.ico' />
    <meta name='viewport' content='width=device-width, initial-scale=1.0'>
    <meta charset='UTF-8'>
    <style>
        .center {margin-left: auto; margin-right: auto; margin-bottom: auto; margin-top: auto;}
        .error-message {color: white;}
        .showhide {-webkit-touch-callout: none; -webkit-user-select: none; -khtml-user-select: none;
                   -moz-user-select: none; -ms-user-select: none; user-select: none; cursor: pointer;
                   margin-bottom:0px; vertical-align: middle;}
        .uicontent {border: 2px solid white;}
        .container {padding: 20px;}
        .advanced {background-color: #dddddd;}
        .slider {-webkit-appearance: none; width: 100%%; height: 25px; background: #659ECE; outline: none;}
        .slider::-webkit-slider-thumb {-webkit-appearance: none; appearance: none; width: 25px; height: 25px;
                                       border-radius: 50%%; background: white; cursor: pointer;}
        .slider::-moz-range-thumb {width: 25px; height: 25px; border-radius: 50%%;  background: white; cursor: pointer;}
        .checkarea {display: block; position: relative; padding-left: 35px; margin-bottom: 12px;
                    cursor: pointer; font-size: 1em; color: white; font-family: Michroma, sans-serif; font-size: 0.9em;
                    -webkit-user-select: none; -moz-user-select: none; -ms-user-select: none; user-select: none;}
        .checkarea input {position: absolute; opacity: 0; cursor: pointer;}
        .checkmark {position: absolute; top: 0; left: 0; height: 24px; width: 24px; background-color: white;}
        .checkarea input:checked ~ .checkmark {background-color: white;}
        .checkmark:after {content: ''; position: absolute; display: none;}
        .checkarea input:checked ~ .checkmark:after {display: block;}
        .checkarea .checkmark:after {left: 9px; top: 5px; width: 8px; height: 15px; border: solid black; border-width: 0px 3px 3px 0px;
                                    -webkit-transform: rotate(45deg); -ms-transform: rotate(45deg); transform: rotate(45deg);}
        body {background-color: #6BA6D7;}
        p {color: white; font-family: Michroma, sans-serif; font-size:0.9em;}
        p.colophon {text-align: center; margin-top: 16px; font-size:0.8em; font-family: Rubik, sans-serif;}
        p.subhead {font-size:1.0em;}
        p.subslider {font-size:0.8em;}
        h2 {color: white; font-family: Michroma, sans-serif; font-weight:bold; margin-top:12px;}
        h5 {color: white; font-family: Michroma, sans-serif; font-size:1.0em;}
        h4 {color: white; font-family: Michroma, sans-serif; margin-bottom:20px; margin-top:28px;}
        hr {border-color: white;}
        td {color: white; font-family: Michroma, sans-serif;}

        @media only screen and (max-width: 640px) {
        .container {padding: 5px;}
        .uicontent {border: 0px;}
        .col-2 {max-width: 0%%; flex: 0 0 0%%;}
        .col-8 {max-width: 100%%; flex: 0 0 100%%;}
        }
    </style>
</head>
<body>
    <div class='container'>
        <div class='uicontent'>
            <!-- Header Row -->
            <div class='row' align='center'>
                <div class='col'>
                    <h2>CLØCK</h2>
                    <h5>Your Digital Clock<br />&nbsp;</h5>
                    <h5 class='clock-status'><i><span>This cløck is online</span></i></h5>
                </div>
            </div>
            <!-- Settings and Controls Row -->
            <div class='row'>
                <div class='col-2'>&nbsp;</div>
                <div class='col-8'>
                    <h4 align='center'>Time Settings</h4>
                    <label class='checkarea'> 24-Hour Mode (Switch off for AM/PM)
                        <input type='checkbox' name='mode' id='mode' value='mode'><span class='checkmark' /></span>
                    </label>
                    <label class='checkarea'> Apply Daylight Savings Time Automatically
                        <input type='checkbox' name='bst' id='bst' value='bst'><span class='checkmark' /></span>
                    </label>
                    <p class='subhead text-center'>World Time</p>
                    <label class='checkarea utc-checkbox'> Show World Time
                        <input type='checkbox' name='utc' id='utc' value='utc'><span class='checkmark' /></span>
                    </label>
                    <input type='range' class='slider' name='utcs' id='utcs' value='0' min='0' max='24' />
                    <table width='100%%'>
                        <tr>
                            <td width='30%%' align='left'><small>-12</small></td>
                            <td width='40%%' align='center'><small>0</small></td>
                            <td width='30%%' align='right'><small>+12</small></td>
                        </tr>
                    </table>
                    <p class='utc-status subslider' align='right'>Offset from local time: <span></span> hours</p>
                    <h4 align='center'>Display Settings</h4>
                    <label class='checkarea'> Show Seconds Indicator
                        <input type='checkbox' name='seconds' id='seconds' value='seconds'><span class='checkmark' /></span>
                    </label>
                    <label class='checkarea'> Flash Seconds Indicator
                        <input type='checkbox' name='flash' id='flash' value='seconds'><span class='checkmark' /></span>
                    </label>
                    <p class='subhead text-center'>Brightness</p>
                    <input type='range' class='slider' name='brightness' id='brightness' value='15' min='1' max='15' />
                    <table width='100%%'>
                        <tr>
                            <td width='50%%' align='left'><small>Low</small></td>
                            <td width='50%%' align='right'><small>High</small></td>
                        </tr>
                    </table>
                    <p class='brightness-status subslider' align='right'>Current brightness: <span></span><br />&nbsp;</p>
                    <div class='onoff-button' align='center'>
                        <button class='btn btn-light' type='submit' id='onoff' style='width:200px'>Turn Display Off</button>
                    </div>
                    <p>&nbsp;</p>
                    <div align='center'>
                        <h4>Alarms</h4>
                        <p class='alarm-list'><span></span></p>
                        <p>Add an Alarm (24-hour clock)</p>
                        <p style='font-size:1em;'>
                            Hour : <input type='text' id='enter-hour' min='0' max='23' style='width:60px;color:black;' placeholder='15' />&nbsp; 
                            Minute : <input type='text' id='enter-min' min='0' max='59' style='width:60px;color:black;' placeholder='00' />&nbsp;
                            Repeat: <input type='checkbox' name='repeat' id='repeat' value=''>
                        </p>
                        <button class='btn btn-light' type='submit' id='setalarm' style='width:200px'>Set Alarm</button>
                    </div>
                    <p>&nbsp;</p>
                    <div class='advancedsettings' style='background-color:#cccccc'>
                        <p class='showhide text-center' style='line-height:36px;color:black;'>Advanced Settings</p>
                        <div class='advanced' align='center'>
                            <br />
                            <div class='debug-checkbox' style='color:black;'>
                                <input type='checkbox' name='debug' id='debug' value='debug' /> Debug Mode
                            </div>
                            <br />
                            <div class='reset-button' align='center'>
                                <button class='btn btn-danger' type='submit' id='reset' style='width:200px'>Reset Cløck</button><br />&nbsp;
                            </div>
                        </div>
                    </div>
                </div>
                <div class='col-2'>&nbsp;</div>
            </div>
            <!-- Colophon Row -->
            <div class='row'>
                <div class='col'>
                    <p class='colophon text-center'>Cløck copyright &copy; 2014-18 Black Pyramid (Time)<br />
                    <a href='https://github.com/smittytone/clock'><img src='https://smittytone.github.io/images/rassilon.png' width='32' height='32' /></a></p>
                </div>
            </div>
        </div>
    </div>

    <script src='https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js'></script>
    <script>
        $('.advanced').hide();

        // Variables
        var agenturl = '%s';
        var displayon = true;

        // Get initial readings
        getState(updateReadout);

        // Begin the online status update loop
        var stateTimer = setInterval(checkState, 20000);

        // Set UI click actions: Checkboxes
        $('#mode').click(setMode);
        $('#bst').click(setBST);
        $('#seconds').click(setColon);
        $('#flash').click(setFlash);
        $('#utc').click(setUTC);
        $('#debug').click(setDebug);

        // Buttons
        $('#reset').click(doReset);
        $('#onoff').click(setLight);
        $('#setalarm').click(setAlarm);

        // Brightness Slider
        var slider = document.getElementById('brightness');
        slider.addEventListener('mouseup', updateBrightness);
        slider.addEventListener('touchend', updateBrightness);
        $('.brightness-status span').text(slider.value);

        // UTC Slider
        slider = document.getElementById('utcs');
        slider.addEventListener('mouseup', updateUTC);
        slider.addEventListener('touchend', updateUTC);
        $('.utc-status span').text(slider.value - 12);
        
        // Configure Show/Hide Advanced Settings toggle
        $('.showhide').click(function(){
            $('.advanced').toggle();
        });

        // Functions
        function updateBrightness() {
            $('.brightness-status span').text($('#brightness').val());
            setBrightness();
        }

        function updateUTC() {
            var u = $('#utcs').val();
            $('.utc-status span').text(u - 12);
            if (document.getElementById('utc').checked == true) {
                setUTC();
            }
        }

        function updateReadout(data) {
            // Extract the current settings from the returned JSON and update the UI accordingly
            var s = JSON.parse(data);
            
            // Set the checkboxes
            document.getElementById('mode').checked = s['mode'];
            document.getElementById('bst').checked = s['bst'];
            document.getElementById('seconds').checked = s['colon'];
            document.getElementById('flash').checked = s['flash'];
            document.getElementById('utc').checked = s['world']['utc'];
            document.getElementById('debug').checked = s['debug'];
            
            // Set the world time offset slider
            var u = parseInt(s['world']['offset']);
            $('.utc-status span').text(u - 12);
            $('#utcs').val(u);

            // Set the title of the display on/off button
            $('#onoff').text(s['on'] ? 'Turn Display Off' : 'Turn Display On');
            displayon = s['on'];

            // Set the display brightness slider
            var b = parseInt(s['bright']);
            $('.brightness-status span').text(b);
            $('#brightness').val(b);

            // Set the line indicating whether the clock is connected to the server or not
            showState(s['isconnected']);

            // Build the list of alarms
            showAlarms(s['alarms']);
        }

        function showState(state) {
            // Update the readout indicating whether the clock is connected or not
            $('.clock-status span').text('This cløck is ' + (state ? 'online' : 'offline'));
        }

        function showAlarms(alarms) {
            // Take the array of alarms sent by the clock and generate a list to present
            if (alarms.length == 0) {
                // No alarms so just show a simple message
                $('.alarm-list span').text('No alarms set');
            } else {
                // Build an HTML table to show the alarms
                // NOTE the device will already have ordered these, so the sequene of alarms in the 'alarms' array
                //      will match the stored sequence held by the device and the agent
                let s = '<p>Current Alarms</p><table width=""100%%"" class=""table table-striped table-sm"">';
                s = s + '<tr><th>&nbsp;</th><th>Time (hour:minute)</th><th>Repeat?</th></th><th>Actions</th></tr>';
                for (var i = 0 ; i < alarms.length ; i++) {
                    let alarm = alarms[i];

                    // Pad out the minutes if necessary
                    let m = (alarm.min < 10 ? '0' : '') + alarm.min.toString();
                    
                    s = s + '<tr><td width=""10%%"" align=""center"">' + (i + 1).toString() + '</td><td width=""50%%"" align=""center"">' + alarm.hour + ':' + m + '</td><td width=""20%%"" align=""center"">' + (alarm.repeat ? 'Yes' : 'No') + '</td><td width=""20%%"" align=""center""><input type=""image"" src=""' + agenturl + '/images/delete.png"" id=""deletealarm' + i.toString() + '""></td></tr>';
                }

                s = s + '</table>';
                $('.alarm-list span').html(s);
                
                // Set each delete button shown to point to the same target function
                for (var i = 0 ; i < alarms.length ; i++) {
                    let s = 'deletealarm' + i.toString();
                    document.getElementById(s).onclick = deleteAlarm;
                }
            }
        }

        function checkState() {
            // Request the current settings to extract the device's online state
            // NOTE This is called periodically via a timer (stateTimer)
            $.ajax({
                url: agenturl + '/status',
                type: 'GET',
                cache: false,
                success: function(response) {
                    var j = JSON.parse(response);
                    if ('connected' in j) {
                        // Update the clock state
                        showState(j['connected']);
                    };
                    if ('force' in j) {
                        // Force a UI update
                        getState(updateReadout);
                    }
                },
                error: function(xhr, textStatus, error) {
                    if (error) {
                        $('.clock-status span').text(error);
                    }
                }
            });
        }

        function getState(callback) {
            // Request the current settings
            $.ajax({
                url: agenturl + '/settings',
                type: 'GET',
                cache: false,
                success: function(response) {
                    if (callback) {
                        callback(response);
                    }
                },
                error: function(xhr, textStatus, error) {
                    if (error) {
                        $('.clock-status span').text(error);
                    }
                }
            });
        }
        
        
        function setMode() {
            updateSettings({'mode':((document.getElementById('mode').checked == true) ? 'true' : 'false')});
        }

        function setBST() {
            updateSettings({'bst':((document.getElementById('bst').checked == true) ? 'true' : 'false')});
        }

        function setColon() {
            updateSettings({'colon':((document.getElementById('seconds').checked == true) ? 'true' : 'false')});
        }

        function setFlash() {
            updateSettings({ 'flash':((document.getElementById('flash').checked == true) ? 'true' : 'false')});
        }

        function setBrightness() {
            updateSettings({'bright':$('#brightness').val()});
        }

        function setLight() {
            displayon = !displayon;
            $('.onoff-button button').text(displayon ? 'Turn Display Off' : 'Turn Display On');
            updateSettings({'on':(displayon ? 'true' : 'false')});
        }

        function setUTC() {
            updateSettings({'world':{'utc':((document.getElementById('utc').checked == true) ? 'true' : 'false'), 'offset':$('#utcs').val()}});
        }
        
        function updateSettings(data) {
            // Generic function to update a setting
            send(data, '/settings');
        }

        function setAlarm() {
            // Set an alarm, using the data entered into the UI
            let h = document.getElementById('enter-hour').value;
            let m = document.getElementById('enter-min').value;
            var d = document.getElementById('repeat').checked == true ? 'true' : 'false';
            let alarmData = {'action':'add', 'hour':h, 'min':m, 'repeat':d};
            send({'alarm':alarmData}, '/settings');
        }

        function deleteAlarm() {
            // Delete an alarm based on its index within the array used to generate the table.
            // Each button's id is set to 'deleteAlarm' plus the array index as a string
            let s = this.id.substring(11);
            let alarmData = {'action':'delete', 'index':s};
            send({'alarm':alarmData}, '/settings');
        }

        function doReset() {
            // Trigger a settings reset
            doAction({'action':'reset'});
        }
        
        function doReboot() {
            // Trigger a device restart
            doAction({'action':'reboot'});
        }

        function setDebug() {
            // Tell the device to enter or leave debug mode
            var d = document.getElementById('debug').checked;
            doAction({'action':'debug', 'debug': d});
        }

        function doAction(action) {
            send(action, '/action');
        }

        function send(data, path) {
            $.ajax({
                url: agenturl + path,
                type: 'POST',
                data: JSON.stringify(data),
                cache: false,
                success: function(response) {
                    // Get updated settings to refresh the UI 
                    getState(updateReadout);
                },
                error: function(xhr, textStatus, error) {
                    if (error) {
                        $('.clock-status span').text(error);
                    }
                }
            });
        }
    </script>
</body>
</html>
